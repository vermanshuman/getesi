<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:p="http://primefaces.org/ui"
                template="/resources/tpl/Admin/EditBase.xhtml">

    <ui:param name="edit_title" value="#{msg.docTemplatesEdit}"/>
    <ui:param name="bean" value="#{documentTemplateEditBean}"/>
    <ui:param name="save_oncomplete" value="onCompleteSave();"/>

    <ui:define name="body">
        <script type="text/javascript">

            function onInitCkEditor(key) {
                const ck = CKEDITOR.instances[key];

                ck.on('fixWidth', function () {
                    fixWidthCKEditor(ck, key);
                });

                pushListeners(ck, key);

                ck.ui.editor.toolbar[8].items[0].onClick(#{bean.pdfZoomValue});
                fixFont(ck);
                fixFontSize(ck);

            }

            function pushListeners(ck, key) {
                $($("#" + key + "Panel").find("iframe")[0].contentDocument).mouseup(function () {
                    setTimeout(function () {
                        fixFont(ck);
                        fixFontSize(ck);
                    }, 50)
                });
            }

            //Below two cycles which install font and font-size as default for ckeditor.

            function fixFont(ck) {
                while (ck.ui.editor.toolbar[3].items[0].getValue() === '') {
                    ck.ui.editor.toolbar[3].items[0].onClick('Courier New');
                }
            }

            function fixFontSize(ck) {
                while (ck.ui.editor.toolbar[3].items[1].getValue() === '') {
                    ck.ui.editor.toolbar[3].items[1].onClick('11');
                }
            }

            function fixWidthCKEditor(ck, key) {
                var newWidth = parseInt(($(`#${key}Panel`).width() - 27) / (ck.ui.editor.toolbar[8].items[0].lastValue / 100), 10);
                $(`#${key}Panel`).find(".cke_wysiwyg_frame").contents().find(key).css('width', newWidth + 'px');
            }

            function onCompleteSave() {
                var array = $('.not_valid');
                var validHeader = true;
                var validBody = true;
                var validFooter = true;
                for (var i = 0; array.length > i; i++) {
                    if (array[i].id == "headerValidator") {
                        $("#header_parent").addClass('not_valid');
                        validHeader = false;
                    }
                    else if (array[i].id == "bodyValidator") {
                        $("#body_parent").addClass('not_valid');
                        validBody = false;
                    }
                    else if (array[i].id == "footerValidator") {
                        $("#footer_parent").addClass('not_valid');
                        validFooter = false;
                    }
                }

                if (validHeader) {
                    $("#header_parent").removeClass('not_valid');
                    $("#header_parent").attr("title", "");
                }
                if (validBody) {
                    $("#body_parent").removeClass('not_valid');
                    $("#body_parent").attr("title", "");
                }
                if (validFooter) {
                    $("#footer_parent").removeClass('not_valid');
                    $("#footer_parent").attr("title", "");
                }
            }

            function insertTagTo(id) {
                var tag = document.getElementById('insertTag').value;
                if (CKEDITOR.instances[id] &amp;&amp; tag != null &amp;&amp; tag.length > 0) {
                    CKEDITOR.instances[id].insertText(tag);
                }
            }

            $(document).ready(function () {
                $("#headerOutputPanel").removeClass('hidden');
                $("#footerOutputPanel").removeClass('hidden');
            });
        </script>

        <h:form id="form" prependId="false" enctype="multipart/form-data">

            <div style="display: none">
                <p:inputText id="headerValidator" label="#{msg.docTemplatesHeader}"/>
                <p:inputText id="bodyValidator" label="#{msg.docTemplatesBody}"/>
                <p:inputText id="footerValidator" label="#{msg.docTemplatesFooter}"/>
            </div>

            <ui:fragment
                    rendered="#{empty showRightPart ? false : showRightPart}">
                <div class="right_part"></div>
            </ui:fragment>

            <div class="content">
                <p:outputPanel id="form_panel">

                    <p:panel header="#{edit_title}">
                        <h:inputHidden id="insertTag" value="#{bean.insertTag}"/>

                        <p:fieldset legend="#{msg.general}">
                            <p:panel id="panelSettings">

                                <ui:include src="/resources/tpl/common/ValidationMessages.xhtml"/>

                                <p:panelGrid columns="4" id="mainPanel"
                                             columnClasses="ui-grid-col-2,ui-grid-col-4, ui-grid-col-2, ui-grid-col-4"
                                             layout="grid"
                                             styleClass="ui-panelgrid-blank form-group">
                                    <span><span class="red">*</span>#{msg.docTemplatesName}:</span>
                                    <p:inputText id="name" value="#{bean.entity.name}"
                                                 maxlength="255" label="#{msg.docTemplatesName}"
                                                 onkeypress="numbers_letters_only('#name');"/>

                                    <span><span class="red">*</span>#{msg.docTemplatesModelType}:</span>
                                    <p:selectOneMenu id="modelType" value="#{bean.modelType}"
                                                     label="#{msg.docTemplatesModelType}">
                                        <f:selectItems value="#{bean.modelTypes}"/>
                                    </p:selectOneMenu>

                                    <span><span class="red">*</span>#{msg.docTemplatesPageWidth}:</span>
                                    <p:spinner maxlength="4" id="spinnerPageWidth"
                                               label="#{msg.docTemplatesPageWidth}"
                                               value="#{bean.entity.width}" stepFactor="1"
                                               onkeyup="check_numbers(this, 4, 0);"
                                               onkeypress="return numbers_only(this, event, 4, 0)"/>

                                    <span><span class="red">*</span>#{msg.docTemplatesPageHeight}:</span>
                                    <p:spinner maxlength="4" id="spinnerPageHeight"
                                               label="#{msg.docTemplatesPageHeight}"
                                               value="#{bean.entity.height}" stepFactor="1"
                                               onkeyup="check_numbers(this, 4, 0);"
                                               onkeypress="return numbers_only(this, event, 4, 0)"/>

                                    <span><span class="red">*</span>#{msg.docTemplatesMarginTop}</span>
                                    <p:spinner maxlength="4" id="spinnerMarginTop"
                                               label="#{msg.docTemplatesMarginTop}"
                                               value="#{bean.entity.marginTop}" stepFactor="1"
                                               onkeyup="check_numbers(this, 4, 0);"
                                               onkeypress="return numbers_only(this, event, 4, 0)"/>

                                    <span><span class="red">*</span>#{msg.docTemplatesMarginBottom}</span>
                                    <p:spinner maxlength="4" id="spinnerMarginBottom"
                                               label="#{msg.docTemplatesMarginBottom}"
                                               value="#{bean.entity.marginBottom}" stepFactor="1"
                                               onkeyup="check_numbers(this, 4, 0);"
                                               onkeypress="return numbers_only(this, event, 4, 0)"/>

                                    <span><span class="red">*</span>#{msg.docTemplatesMarginLeft}</span>
                                    <p:spinner maxlength="4" id="spinnerMarginLeft"
                                               label="#{msg.docTemplatesMarginLeft}"
                                               value="#{bean.entity.marginLeft}" stepFactor="1"
                                               onkeyup="check_numbers(this, 4, 0);"
                                               onkeypress="return numbers_only(this, event, 4, 0)"/>

                                    <span><span class="red">*</span>#{msg.docTemplatesMarginRight}</span>
                                    <p:spinner maxlength="4" id="spinnerMarginRight"
                                               label="#{msg.docTemplatesMarginRight}"
                                               value="#{bean.entity.marginRight}" stepFactor="1"
                                               onkeyup="check_numbers(this, 4, 0);"
                                               onkeypress="return numbers_only(this, event, 4, 0)"/>

                                    <span>#{msg.docTemplatesEnableHeader}</span>
                                    <p:selectBooleanCheckbox id="enableHeader"
                                                             widgetVar="enableHeaderWV" value="#{bean.entity.header}">
                                        <p:ajax event="change" update=":form:headerRend"/>
                                    </p:selectBooleanCheckbox>

                                    <span>#{msg.docTemplatesEnableFooter}</span>
                                    <p:selectBooleanCheckbox id="enableFooter"
                                                             widgetVar="enableFooterWV" value="#{bean.entity.footer}">
                                        <p:ajax event="change" update=":form:footerRend"/>
                                    </p:selectBooleanCheckbox>
                                </p:panelGrid>

                                <div align="center">
                                    <p:outputPanel id="headerRend">
                                        <p:outputPanel id="headerOutputPanel" rendered="#{bean.entity.header}">

                                            <p:separator id="headerSeparator"
                                                         style="width:100%;height:10px"/>

                                            <h:outputText id="headerLabel"
                                                          value="#{msg.docTemplatesHeader}:"/>
                                            <br/>

                                            <p:panelGrid id="gridHeader" columns="2"
                                                         styleClass="ui-panelgrid-blank form-group">
                                                <span><span class="red">*</span>#{msg.docTemplatesHeaderHeight}:</span>

                                                <p:spinner maxlength="4" id="spinnerHeaderHeight"
                                                           label="#{msg.docTemplatesHeaderHeight}"
                                                           value="#{bean.entity.headerHeight}" stepFactor="1"
                                                           onkeyup="check_numbers(this, 4, 0);"
                                                           onkeypress="return numbers_only(this, event, 4, 0)"/>
                                            </p:panelGrid>

                                            <p:panelGrid id="gridHeaderNew" columns="2"
                                                         styleClass="ui-panelgrid-blank form-group">
                                                <p:selectOneMenu value="#{bean.selectedTagHeader}">
                                                    <f:selectItems value="#{bean.tagsEx}"/>
                                                </p:selectOneMenu>
                                                <p:commandButton action="#{bean.addTagHeader}"
                                                                 update="insertTag" oncomplete="insertTagTo('header')"
                                                                 value="#{msg.docTemplatesAddTag}" immediate="false"/>
                                            </p:panelGrid>

                                            <div id="headerPanel">
                                                <pe:ckEditor id="header" styleClass="for_editor"
                                                             label="#{msg.docTemplatesEnableHeader}" width="'auto'"
                                                             value="#{bean.entity.headerContent}" widgetVar="headerWV"
                                                             contentsCss="#{facesContext.externalContext.requestContextPath}/resources/javascript/CKEditorStyles.css"
                                                             customConfig="#{facesContext.externalContext.requestContextPath}/resources/javascript/configCKEditor.js">
                                                    <p:ajax event="initialize" oncomplete="onInitCkEditor('header');"/>
                                                    <p:ajax event="wysiwygMode"
                                                            oncomplete="pushListeners(CKEDITOR.instances['header'], 'header');"/>
                                                </pe:ckEditor>
                                            </div>

                                        </p:outputPanel>
                                    </p:outputPanel>

                                    <p:separator style="width:100%;height:10px"/>

                                    #{msg.docTemplatesBody}: <br/>
                                    <div align="center">
                                        <p:panelGrid id="gridBody" columns="2"
                                                     styleClass="ui-panelgrid-blank form-group">
                                            <p:selectOneMenu value="#{bean.selectedTag}">
                                                <f:selectItems value="#{bean.tags}"/>
                                            </p:selectOneMenu>

                                            <p:commandButton action="#{bean.addTagBody}"
                                                             update="insertTag" oncomplete="insertTagTo('body')"
                                                             value="#{msg.docTemplatesAddTag}" immediate="false"/>
                                        </p:panelGrid>
                                    </div>
                                    <br/>

                                    <div id="bodyPanel">
                                        <pe:ckEditor id="body" value="#{bean.entity.bodyContent}"
                                                     styleClass="for_editor" width="'auto'"
                                                     contentsCss="#{facesContext.externalContext.requestContextPath}/resources/javascript/CKEditorStyles.css"
                                                     customConfig="#{facesContext.externalContext.requestContextPath}/resources/javascript/configCKEditor.js"
                                                     widgetVar="ckEditorWV">
                                            <p:ajax event="initialize" oncomplete="onInitCkEditor('body');"/>
                                            <p:ajax event="wysiwygMode"
                                                    oncomplete="pushListeners(CKEDITOR.instances['body'], 'body');"/>
                                        </pe:ckEditor>
                                    </div>

                                    <p:outputPanel id="footerRend">
                                        <p:outputPanel id="footerOutputPanel" rendered="#{bean.entity.footer}">
                                            <p:separator id="footerSeparator"
                                                         style="width:100%;height:10px"/>

                                            <h:outputText id="footerLabel"
                                                          value="#{msg.docTemplatesFooter}:"/>
                                            <br/>

                                            <div align="center">
                                                <p:panelGrid id="gridFooter" columns="2"
                                                             styleClass="ui-panelgrid-blank form-group">
                                                    <span><span
                                                            class="red">*</span>#{msg.docTemplatesFooterHeight}:</span>

                                                    <p:spinner maxlength="4" id="spinnerFooterHeight"
                                                               label="#{msg.docTemplatesFooterHeight}"
                                                               value="#{bean.entity.footerHeight}" stepFactor="1"/>
                                                </p:panelGrid>

                                                <p:panelGrid id="gridFooterNew" columns="2"
                                                             styleClass="ui-panelgrid-blank form-group">
                                                    <p:selectOneMenu value="#{bean.selectedTagFooter}">
                                                        <f:selectItems value="#{bean.tagsEx}"/>
                                                    </p:selectOneMenu>

                                                    <p:commandButton action="#{bean.addTagFooter}"
                                                                     update="insertTag"
                                                                     oncomplete="insertTagTo('footer')"
                                                                     value="#{msg.docTemplatesAddTag}"
                                                                     immediate="false"/>
                                                </p:panelGrid>
                                            </div>

                                            <div id="footerPanel">
                                                <pe:ckEditor id="footer" styleClass="for_editor"
                                                             label="#{msg.docTemplatesEnableFooter}" width="'auto'"
                                                             value="#{bean.entity.footerContent}" widgetVar="footerWV"
                                                             customConfig="#{facesContext.externalContext.requestContextPath}/resources/javascript/configCKEditor.js"
                                                             contentsCss="#{facesContext.externalContext.requestContextPath}/resources/javascript/CKEditorStyles.css">
                                                    <p:ajax event="initialize" oncomplete="onInitCkEditor('footer');"/>
                                                    <p:ajax event="wysiwygMode"
                                                            oncomplete="pushListeners(CKEDITOR.instances['footer'], 'footer');"/>
                                                </pe:ckEditor>
                                            </div>
                                        </p:outputPanel>
                                    </p:outputPanel>
                                </div>
                            </p:panel>
                        </p:fieldset>

                        <p:outputPanel id="btn_line">
                            <div class="btn_line">
                                <p:commandButton action="#{bean.pageSave}" value="#{msg.save}"
                                                 oncomplete="#{save_oncomplete}" icon="ui-icon-disk"
                                                 update="mainPanel, messages, spinnerHeaderHeight, spinnerFooterHeight, headerValidator, bodyValidator, footerValidator"/>

                                <p:commandButton action="#{bean.goBack}" value="#{msg.cancel}"
                                                 icon="ui-icon-circle-close"/>
                            </div>
                        </p:outputPanel>
                    </p:panel>
                </p:outputPanel>

                <p:growl id="messages" showDetail="true" autoUpdate="false"
                         globalOnly="true"/>
            </div>
        </h:form>
    </ui:define>
</ui:composition>