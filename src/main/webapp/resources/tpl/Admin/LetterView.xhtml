<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui">
    <link href="#{facesContext.externalContext.requestContextPath}/resources/chart/css/demo.css"
          media="all" rel="stylesheet" type="text/css"/>
    <style>
        .simple-table thead th {
            border: 1px solid #5f666c !important;
        }

        body .ui-datatable thead th {
            border-color: #5f666c !important;
        }

        body .ui-datatable .ui-datatable-data > tr > td {
            padding: 1rem 1rem;
            border: 1px solid #5f666c !important;
            text-align: center;
        }

        body .ui-datatable .ui-datatable-header {
            background: #f8f9fa;
            border-width: 1px 0 0 0;
            border-style: solid;
            border-color: #5f666c;
            border-radius: 0;
        }
        th.small-btn-column {
            width: 51px !important;
        }
        td.small-btn-column {
            width: 59px;
        }
        #showToBeSentRequestPanel th:nth-child(2) {
            width: 301px !important;
        }
    </style>

    <p:panel id="button_panel" toggleable="true"
             style="overflow-y: auto; overflow-x: hidden; word-wrap: break-word; white-space: normal; border: 0;z-index: 1000">
        <ui:include src="/resources/tpl/Admin/Include/LetterLine.xhtml"/>
    </p:panel>

    <p:panel id="letter_panel" toggleable="true"
             style="overflow-y: auto; overflow-x: hidden; word-wrap: break-word; white-space: normal; margin-top: 0; position: relative; top: 25px; border: 0; 
             margin-bottom: 68px;">

        <p:panelGrid columns="2" styleClass="ui-panelgrid-blank form-group" id="referenceAreaShow">

            <h:outputText value="#{msg.clientType}:"/>
            <p:selectOneMenu id="clientType" value="#{bean.clientTypeId}"
                             styleClass="select-width w-100" label="#{msg.clientType}">
                <f:selectItems value="#{bean.clientTypes}" />
                <p:ajax event="change" listener="#{bean.initOfficesList(true)}" update="client_not_manger_or_fiduciary_id mail_ofice_id managers client_invoice_id"/>
            </p:selectOneMenu>
            <h:outputText value="#{msg.client}:"/>
            <p:selectOneMenu id="client_not_manger_or_fiduciary_id"
                             value="#{bean.selectedNotManagerOrFiduciaryClientId}"
                             styleClass="input-width-mmv w-100">
                <f:selectItems value="#{bean.notManagerOrFiduciaryClients}"/>
                <p:ajax event="change" listener="#{bean.initOfficesList(true)}" update="mail_ofice_id managers client_invoice_id"/>
            </p:selectOneMenu>

            <h:outputText value="#{msg.mailBilling}:"/>
            <p:selectOneMenu id="client_invoice_id" value="#{bean.selectedClientInvoiceId}"
                             styleClass="input-width-mmv w-100">
                <f:selectItems value="#{bean.invoiceClients}"/>
            </p:selectOneMenu>

            <h:outputText value="#{msg.mailTrust}:"/>
            <p:inputText id="fiduciary_text" value="#{bean.fiduciary}"  styleClass="w-100"/>
<!--            <p:selectOneMenu id="client_fiduciary_id" value="#{bean.selectedClientFiduciaryId}" styleClass="input-width-mmv w-100">-->
<!--                <f:selectItems value="#{bean.fiduciaryClientsList}"/>-->
<!--            </p:selectOneMenu>-->


            <span>#{msg.clientManager}</span>
            <p:selectCheckboxMenu id="managers" value="#{bean.selectedClientManagers}" styleClass="w-100"
                                  label="#{enums.documentGenerationTagsMANAGER}"
                                  converter="#{bean.clientSelectItemWrapperConverter}"
                                  multiple="true" filter="true" filterMatchMode="startsWith" >
                <f:selectItems value="#{bean.clientManagers}" var="con" itemValue="#{con}"
                               itemLabel="#{con.label}"/>
                <p:ajax process="managers"/>
            </p:selectCheckboxMenu>

            <h:outputText value="#{msg.mailManagerViewOffice}:"/>
            <p:selectOneMenu id="mail_ofice_id" value="#{bean.selectedOfficeId}" styleClass="input-width-mmv w-100">
                <f:selectItems value="#{bean.officeList}"/>
            </p:selectOneMenu>
            <span> #{msg.ndgText}</span>
            <p:inputText id="ndgShow" value="#{bean.ndg}"  styleClass="w-100" disabled="#{bean.sentToBrexa}"/>
            <span> #{msg.cdrText}</span>
            <p:inputText id="cdrShow" value="#{bean.cdr}"  styleClass="w-100" disabled="#{bean.sentToBrexa}"/>
            <span> #{msg.reference}</span>
            <p:inputTextarea id="referenceShow" value="#{bean.referencePractice}" styleClass="w-100" disabled="#{bean.sentToBrexa}"/>
            <p:outputPanel style="margin-top: 2mm;position: absolute;" id="buttonPanel">
                <p:commandButton value="#{msg.save}" process="referenceAreaShow" style="background-color: #00CC52 !important; margin-right:5px;width: 110px;" 
                				 icon="fa fa-floppy-o" iconPos="left"
                                 action="#{bean.checkOtherClient(false, 0)}">
                    <f:setPropertyActionListener value="#{true}" target="#{bean.confirmButtonIsClicked}"/>
                </p:commandButton>
                <p:commandButton value="#{msg.mailManagerStart}" process="referenceAreaShow" style="background-color: #000066 !important;margin-left: 1cm;width: 110px;"
                                 action="#{bean.checkFieldsBeforeProcessManagedStateCheck}" update="chooseSingleOrMultipleRequestCreate"
                                 disabled="#{bean.sentToBrexa}">
                    <f:setPropertyActionListener value="#{true}" target="#{bean.confirmButtonIsClicked}"/>
                </p:commandButton>
                
                <p:commandButton value="#{msg.mailManagerViewSendToBrexa}" styleClass="grey-button" rendered="#{!bean.sentToBrexa}"
                              action="#{bean.validateClientSelected(true)}" style="margin-left: 5cm;"/>
                <ui:fragment>
		            <span  style="border: 2px solid #788fa7 !important;padding: 5px 8px 8px 4px; border-radius: 2px; 
		            		display: #{bean.sentToBrexa ? 'inline-block' :  'none' }; border: 2px solid #57c279 !important; margin-left: 5cm;" >
		                <i style="color: green; margin-right: 5px; margin-left: 5px;"/>
		                <p:commandLink value="#{msg.mailManagerViewSentToBrexa}" 
		                	oncomplete="PF('unblockMailDialogWV').show();" disabled="#{bean.disableSentToBrexa}"/>
		            </span>
                </ui:fragment>
            </p:outputPanel>
        </p:panelGrid>
        <br/><br/>
        <div class="p-grid table-demo" style="margin-top: 35px;">
            <div class="p-col-12">
                <div class="card">
                    <p:dataTable widgetVar="validRequestsDT" var="item" value="#{bean.entity.validRequests}" reflow="true" styleClass="simple-table"
                                 rendered="#{not empty bean.entity.validRequests}" emptyMessage="#{msg.noRecordsFound}">
                        <p:column styleClass=" action_column" style="padding: 6px 7px !important;">
                            <p:commandButton icon="ui-icon pi pi-pencil" update=":form" action="#{bean.gotoEditRequest}" style="width: 32px;">
                                <f:setPropertyActionListener value="#{item.id}" target="#{bean.entityEditId}"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="action_column" exportable="false" style="padding: 6px 7px !important;">
	                        <p:commandButton icon="ui-icon pi pi-times" styleClass="red-btn" oncomplete="PF('requestDeleteDialogWV').show()">
	                            <f:setPropertyActionListener value="#{item.id}" target="#{bean.entityDeleteId}"/>
	                        </p:commandButton>
                        </p:column>
                        <p:column headerText="#{msg.databaseListRealEstateSubject}" sortBy="#{item.mailViewSubject}" filterBy="#{item.mailViewSubject}">
                            <h:outputText value="#{item.mailViewSubject}" escape="false"/>
                        </p:column>
                        <p:column headerText="#{msg.requestListRequestType}" sortBy="#{item.mailViewSubject}" filterBy="#{item.mailViewSubject}">
                            <h:outputText value="#{item.requestTypeName}"/>
                        </p:column>
                        <p:column headerText="#{msg.requestListService}" sortBy="#{item.mailViewSubject}" filterBy="#{item.mailViewSubject}">
                            <h:outputText value="#{item.service ne null ? item.serviceName : (item.multipleServices ne null ? item.multipleServiceNames : '')}"/>
                            <div style="min-height: 30px; position:relative; left: -125px; bottom: -18px;">
                                <p:graphicImage id="special-formality-#{loop.index}" url="/resources/images/tooltip.png"
                                                style="width:20px;height:20px;"
                                                rendered="#{not empty item.textInVisura}" />
                                <p:tooltip for="special-formality-#{loop.index}" styleClass="custom-design-tooltip">
                                    <h:outputText value="#{item.textInVisura}" style="color:#003871;"/>
                                </p:tooltip>
                            </div>
                        </p:column>
                        <p:column headerText="#{msg.requestListCorservatoryName}" sortBy="#{item.mailViewSubject}" filterBy="#{item.mailViewSubject}">
                            <h:outputText value="#{item.aggregationLandCharRegNameOrCity}"/>
                        </p:column>
                        <p:column headerText="#{msg.requestState}" sortBy="#{item.mailViewSubject}" filterBy="#{item.mailViewSubject}">
                            <h:outputText value="#{item.stateDescription}"/>
                        </p:column>
                        <p:column headerText="#{msg.invoiceNumber}">
                            <p:commandLink value="#{item.invoice.invoiceNumber}" action="#{bean.openInvoiceDialog}" update="invoiceDialogBilling dialogTab">
                                <f:setPropertyActionListener value="#{item}" target="#{bean.examRequest}"/>
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                </div>
            </div>
        </div>
        <br/><br/>
        <div style="overflow: hidden; width: 0px; height: 0px; margin: 0; padding: 0; display: none">
            <p:fileUpload id="mail_file_upload" fileUploadListener="#{bean.handleFileUpload}"
                          mode="advanced" auto="true" update="letter_panel"/>
        </div>

        <p:outputPanel id="onlyBody" style="color:black !important">
            <div class="ui-g">
                <div class="ui-g-3"
                     style="border-radius: 50%; background-color: #2f8ee5; width: 50px; height: 50px; text-align: center">
                    <h:outputText converter="mailLetterConverter" value="#{bean.entity.emailFrom}"
                                  styleClass="one_mail_letter"/>
                </div>
                <div class="ui-g-9">
                    <div>
                        <h:outputText value="#{bean.entity.emailFrom}"
                                      styleClass="worklist-expansion-value" style="font-size: 12.5pt;"/>
                    </div>
                    <div>
                        <h:outputText value="#{bean.entity.sendDate}" converter="dateTimeConverterWithMinutes"
                                      rendered="#{!bean.entity.received}" style="font-size: 10pt;"/>
                        <h:outputText value="#{bean.entity.sendDate}" converter="dateTimeConverterWithMinutesLocal"
                                      rendered="#{bean.entity.received}" style="font-size: 10pt;"/>
                    </div>
                    <div>
                        <h:outputText value="#{bean.entity.emailBCC}"
                                      styleClass="worklist-expansion-value"
                                      style="font-size: 9pt; color: black; font-weight: bold"/>
                    </div>
                    <div>
                        <h:outputText value="#{bean.entity.priorityWrapper.message}"
                                      rendered="#{not empty bean.entity.priorityWrapper.message}"
                                      style="font-size: 10pt;"/>
                    </div>
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-2">
                    <h:outputText value="#{msg.mailManagerEmailTo}:"
                                  rendered="#{not empty bean.entity.emailTo}"/>
                </div>
                <div class="ui-g-10">
                    <h:outputText value="#{bean.entity.emailTo}"
                                  rendered="#{not empty bean.entity.emailTo}"/>
                </div>
            </div>
            <div class="ui-g" style="#{empty bean.entity.emailCC ? 'display: none' : ''}">
                <div class="ui-g-2">
                    <h:outputText value="#{msg.mailManagerEditMailCopy}:"
                                  rendered="#{not empty bean.entity.emailCC}"/>
                </div>
                <div class="ui-g-10">
                    <h:outputText value="#{bean.entity.emailCC}"
                                  rendered="#{not empty bean.entity.emailCC}"/>
                </div>
            </div>
            <div class="ui-g" style="#{empty bean.entity.emailSubject ? 'display: none' : ''}">
                <div class="ui-g-2">
                    <h:outputText value="#{msg.mailManagerEditMailSubject}:"
                                  rendered="#{not empty bean.entity.emailSubject}"/>
                </div>
                <div class="ui-g-10">
                    <h:outputText value="#{bean.entity.emailSubject}"
                                  rendered="#{not empty bean.entity.emailSubject}"/>
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-2">
                    <h:outputText value="#{msg.mailManagerAttachedFiles}:"
                                  rendered="#{not empty bean.attachedFiles}"/>
                </div>
                <div class="ui-g-10 attach-files">
                    <ui:repeat value="#{bean.attachedFiles}" var="file">
                        <div style="display: flex;align-items: center;height: 30px;">
                            <i class="#{file.icon} #{file.style}"/>
                            <p:commandLink title="#{msg.download}" update=":form, messages" ajax="false"
                                           action="#{bean.downloadFile}" value="&nbsp;#{file.fileName}"
                                           style="color: black; padding-right: 5px;font-size: 13px !important;">
                                <f:setPropertyActionListener value="#{file.id}" target="#{bean.downloadFileIndex}"/>
                            </p:commandLink>
                        </div>
                    </ui:repeat>
                </div>
            </div>
            <p:separator/>
            <div class="ui-g">
                <div class="ui-g-12">
                    <h:outputText value="#{bean.emailBody}" escape="false" styleClass="email-body-black"/>
                </div>
            </div>
        </p:outputPanel>
    </p:panel>
    <p:dialog id="saveConfirmationDialog" closable="true" widgetVar="saveConfirmationDialogWV" modal="true" width="250" styleClass="dialog-green dialog-green-width"
              draggable="false" resizable="false" style="text-align: center;" >
        <h:outputText style="font-size: 16px;" id="confirmationMsg" value="#{msg.mailManagerSave}"/>
        <br/>
    </p:dialog>
    <p:dialog id="showToBeSentRequest" widgetVar="showToBeSentRequestDlgWV" styleClass="table-center"
              modal="true" width="1200"
              header="#{msg.selectToBeSentRequest}">
        <p:outputPanel widgetVar="showToBeSentRequestPanel" id="showToBeSentRequestPanel">
            <p:dataTable value="#{bean.entity.fullFillRequests}" styleClass="simple-table" var="item" style="margin-top: 20px;"
                         rendered="#{not empty bean.entity.validRequests}" scrollHeight="300" scrollable="true" emptyMessage="#{msg.noRecordsFound}">
                <p:column width="7%" styleClass="small-btn-column">
                    <p:selectBooleanCheckbox value="#{item.selected}"/>
                </p:column>
                <p:column headerText="#{msg.databaseListRealEstateSubject}">
                    <h:outputText value="#{item.mailViewSubject}"/>
                </p:column>
                <p:column headerText="#{msg.requestListRequestType}">
                    <h:outputText value="#{item.requestTypeName}"/>
                </p:column>
                <p:column headerText="#{msg.requestListService}">
                    <h:outputText value="#{item.service ne null ? item.serviceName : (item.multipleServices ne null ? item.multipleServiceNames : '')}"/>
                </p:column>
                <p:column headerText="#{msg.requestListCorservatoryName}">
                    <h:outputText value="#{item.aggregationLandCharRegNameOrCity}"/>
                </p:column>
            </p:dataTable>
            <div class="btn_line">
                <p:commandButton value="#{msg.confirm}"
                                 action="#{bean.openMailManagerEditor}"
                                 update="form" style="background-color: #00CC52 !important;margin-right: 15px;width: 100px;"
                                 oncomplete="PF('showToBeSentRequestDlgWV').hide();"/>
                <p:commandButton value="#{msg.cancel}" style="background-color: #F3362B !important;width: 100px;"
                                 oncomplete="PF('showToBeSentRequestDlgWV').hide();"/>
            </div>
        </p:outputPanel>
    </p:dialog>
    
    <p:dialog id="unblockMailDialog" closable="true" widgetVar="unblockMailDialogWV" modal="true" width="250" styleClass="dialog-green dialog-green-width"
              draggable="false" resizable="false" style="text-align: center;" >
        <h:outputText id="mailManagerViewUnblockMailMsg" value="#{msg.mailManagerViewUnblockMailMsg}"/>
        <div class="btn_line">
	        <p:commandButton value="#{msg.confirm}" action="#{bean.setExternalBrexa(false)}"
	                         oncomplete="PF('unblockMailDialogWV').hide();" update="@form buttonPanel"
	                         style="background-color: #00CC52 !important;margin-right: 15px;width: 100px;"/>
	        <p:commandButton value="#{msg.cancel}" 
	                         oncomplete="PF('unblockMailDialogWV').hide();"
	                         style="background-color: #F3362B !important; width: 100px;"/>
        </div>
    </p:dialog>

    <p:dialog widgetVar="mailManagerViewMissingClientDialogWV"  id="mailManagerViewMissingClientDialog" modal="true"
              styleClass="dialog-red" resizable="false" draggable="false" effect="SLIDE" header="">
        <h:outputText id="mailManagerViewMissingClientMsg" value="#{msg.mailManagerViewMissingClientMsg}"/>
        <div class="btn_line">
            <p:commandButton value="#{msg.close}" styleClass="confirm-button"
                             style="margin-right: 15px;"
                             oncomplete="PF('mailManagerViewMissingClientDialogWV').hide();"/>
        </div>
    </p:dialog>
    
    <ui:include src="/resources/tpl/Admin/Include/MailManagerDialog.xhtml"/>
</ui:composition>
